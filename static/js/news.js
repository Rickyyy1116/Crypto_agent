// News Page JavaScript for Cryptocurrency Trading Assistant

class CryptoNewsApp {
    constructor() {
        this.currentPage = 1;
        this.newsData = [];
        this.filteredNews = [];
        this.isLoading = false;
        this.theme = localStorage.getItem('news-theme') || 'light';
        
        this.init();
    }

    init() {
        this.setupEventListeners();
        this.setTheme(this.theme);
        this.loadNews();
    }

    setupEventListeners() {
        // Theme toggle
        document.getElementById('themeToggle')?.addEventListener('click', () => {
            this.toggleTheme();
        });

        // Filter controls
        document.getElementById('categoryFilter')?.addEventListener('change', () => {
            this.applyFilters();
        });

        document.getElementById('sourceFilter')?.addEventListener('change', () => {
            this.applyFilters();
        });

        document.getElementById('timeFilter')?.addEventListener('change', () => {
            this.applyFilters();
        });

        // Refresh button
        document.getElementById('refreshNews')?.addEventListener('click', () => {
            this.refreshNews();
        });

        // Load more button
        document.getElementById('loadMore')?.addEventListener('click', () => {
            this.loadMoreNews();
        });
    }

    toggleTheme() {
        this.theme = this.theme === 'light' ? 'dark' : 'light';
        this.setTheme(this.theme);
        localStorage.setItem('news-theme', this.theme);
    }

    setTheme(theme) {
        document.documentElement.setAttribute('data-theme', theme);
        const themeToggle = document.getElementById('themeToggle');
        if (themeToggle) {
            const icon = themeToggle.querySelector('i');
            if (theme === 'dark') {
                icon.className = 'fas fa-sun';
            } else {
                icon.className = 'fas fa-moon';
            }
        }
    }

    async loadNews() {
        if (this.isLoading) return;
        
        this.isLoading = true;
        this.showLoadingSpinner(true);
        
        try {
            const response = await fetch('/api/crypto-news?limit=20');
            if (response.ok) {
                const newsData = await response.json();
                this.newsData = this.enhanceNewsData(newsData);
                this.filteredNews = [...this.newsData];
                this.displayNews();
            } else {
                // Fallback to sample news
                this.displaySampleNews();
            }
        } catch (error) {
            console.error('Error loading news:', error);
            this.displaySampleNews();
        } finally {
            this.isLoading = false;
            this.showLoadingSpinner(false);
        }
    }

    enhanceNewsData(newsData) {
        return newsData.map(item => {
            // Categorize news
            const category = this.categorizeNews(item.title, item.summary);
            
            // Analyze sentiment
            const sentiment = this.analyzeSentiment(item.title, item.summary);
            
            // Add enhanced properties
            return {
                ...item,
                category,
                sentiment,
                publishedDate: new Date(item.published),
                id: `news-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`
            };
        });
    }

    categorizeNews(title, summary) {
        const text = (title + ' ' + summary).toLowerCase();
        
        if (text.includes('bitcoin') || text.includes('btc')) return 'bitcoin';
        if (text.includes('ethereum') || text.includes('eth')) return 'ethereum';
        if (text.includes('defi') || text.includes('decentralized')) return 'defi';
        if (text.includes('regulation') || text.includes('regulatory') || text.includes('Ë¶èÂà∂')) return 'regulation';
        if (text.includes('blockchain') || text.includes('technology') || text.includes('tech')) return 'technology';
        
        return 'general';
    }

    analyzeSentiment(title, summary) {
        const text = (title + ' ' + summary).toLowerCase();
        
        const positiveWords = [
            'surge', 'rally', 'bullish', 'gains', 'rise', 'positive', 'breakthrough', 'adoption',
            'growth', 'boom', 'soar', 'spike', 'moon', 'bull', 'up', 'high', 'record',
            '‰∏äÊòá', 'ÊÄ•È®∞', 'Âº∑Ê∞ó', 'Âà©Áõä', 'Â¢óÂä†', 'ÂâçÂêë„Åç', 'Á™ÅÁ†¥', 'Êé°Áî®', 'ÊàêÈï∑', 'Â•ΩË™ø', 'Ë≤∑„ÅÑ'
        ];
        
        const negativeWords = [
            'crash', 'dump', 'bearish', 'decline', 'fall', 'negative', 'concern', 'regulation',
            'drop', 'plunge', 'bear', 'down', 'low', 'sell', 'fear', 'risk',
            'Êö¥ËêΩ', '„ÉÄ„É≥„Éó', 'Âº±Ê∞ó', '‰∏ãËêΩ', 'ËêΩ‰∏ã', 'Âê¶ÂÆöÁöÑ', 'Êá∏Âøµ', 'Ë¶èÂà∂',
            '‰Ωé‰∏ã', 'ÊÄ•ËêΩ', 'ÁÜä', '‰∏ã', '‰Ωé„ÅÑ', 'Â£≤„Çä', 'ÊÅêÊÄñ', '„É™„Çπ„ÇØ', '‰∏çÂÆâ'
        ];
        
        const posCount = positiveWords.filter(word => text.includes(word)).length;
        const negCount = negativeWords.filter(word => text.includes(word)).length;
        
        if (posCount > negCount) return 'positive';
        if (negCount > posCount) return 'negative';
        return 'neutral';
    }

    displayNews() {
        const container = document.getElementById('newsContainer');
        if (!container) return;

        if (this.filteredNews.length === 0) {
            this.showNoResults();
            return;
        }

        const newsHtml = this.filteredNews.map((item, index) => this.createNewsCard(item, index)).join('');
        container.innerHTML = newsHtml;

        // Add click listeners
        this.addNewsCardListeners();
        
        // Show load more button if there are more items
        const loadMoreBtn = document.getElementById('loadMore');
        if (loadMoreBtn && this.filteredNews.length >= 10) {
            loadMoreBtn.style.display = 'block';
        }
    }

    createNewsCard(item, index) {
        const timeAgo = this.formatTimeAgo(item.publishedDate);
        const categoryClass = `category-${item.category}`;
        const sentimentClass = `sentiment-${item.sentiment}`;
        const sentimentIcon = this.getSentimentIcon(item.sentiment);
        
        return `
            <div class="col-lg-4 col-md-6 mb-4">
                <div class="news-card stagger-animation" data-news-id="${item.id}" style="animation-delay: ${index * 0.1}s">
                    <div class="news-card-image">
                        <i class="news-icon ${this.getCategoryIcon(item.category)}"></i>
                        <div class="news-card-source">${item.source}</div>
                    </div>
                    <div class="news-card-body">
                        <div class="category-badge ${categoryClass}">
                            ${this.getCategoryLabel(item.category)}
                        </div>
                        <h3 class="news-card-title">${item.title}</h3>
                        <p class="news-card-summary">${item.summary || '„Éã„É•„Éº„ÇπË©≥Á¥∞„ÇíË™≠„ÅøËæº„Åø‰∏≠...'}</p>
                        <div class="news-card-footer">
                            <div class="news-card-time">
                                <i class="fas fa-clock"></i>
                                ${timeAgo}
                            </div>
                            <div class="news-card-sentiment ${sentimentClass}">
                                ${sentimentIcon} ${this.getSentimentLabel(item.sentiment)}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }

    getCategoryIcon(category) {
        const icons = {
            bitcoin: 'fab fa-bitcoin',
            ethereum: 'fab fa-ethereum',
            defi: 'fas fa-coins',
            regulation: 'fas fa-gavel',
            technology: 'fas fa-microchip',
            general: 'fas fa-newspaper'
        };
        return icons[category] || icons.general;
    }

    getCategoryLabel(category) {
        const labels = {
            bitcoin: 'Bitcoin',
            ethereum: 'Ethereum',
            defi: 'DeFi',
            regulation: 'Ë¶èÂà∂',
            technology: 'ÊäÄË°ì',
            general: '‰∏ÄËà¨'
        };
        return labels[category] || labels.general;
    }

    getSentimentIcon(sentiment) {
        const icons = {
            positive: 'üòä',
            negative: 'üòü',
            neutral: 'üòê'
        };
        return icons[sentiment] || icons.neutral;
    }

    getSentimentLabel(sentiment) {
        const labels = {
            positive: '„Éù„Ç∏„ÉÜ„Ç£„Éñ',
            negative: '„Éç„Ç¨„ÉÜ„Ç£„Éñ',
            neutral: '„Éã„É•„Éº„Éà„É©„É´'
        };
        return labels[sentiment] || labels.neutral;
    }

    addNewsCardListeners() {
        document.querySelectorAll('.news-card').forEach(card => {
            card.addEventListener('click', (e) => {
                const newsId = e.currentTarget.dataset.newsId;
                const newsItem = this.filteredNews.find(item => item.id === newsId);
                if (newsItem) {
                    this.showNewsModal(newsItem);
                }
            });
        });
    }

    showNewsModal(newsItem) {
        const modal = document.getElementById('newsModal');
        const modalTitle = document.getElementById('newsModalTitle');
        const modalContent = document.getElementById('newsModalContent');
        const modalLink = document.getElementById('newsModalLink');

        if (modalTitle) modalTitle.textContent = newsItem.title;
        if (modalLink) modalLink.href = newsItem.url;

        if (modalContent) {
            const sentimentClass = `sentiment-${newsItem.sentiment}`;
            const sentimentIcon = this.getSentimentIcon(newsItem.sentiment);
            
            modalContent.innerHTML = `
                <div class="news-modal-meta">
                    <div class="news-modal-source">${newsItem.source}</div>
                    <div class="news-modal-time">
                        <i class="fas fa-clock me-1"></i>
                        ${this.formatTimeAgo(newsItem.publishedDate)}
                    </div>
                    <div class="ms-auto">
                        <span class="news-card-sentiment ${sentimentClass}">
                            ${sentimentIcon} ${this.getSentimentLabel(newsItem.sentiment)}
                        </span>
                    </div>
                </div>
                <div class="news-modal-content">
                    <p>${newsItem.summary || '„Åì„ÅÆË®ò‰∫ã„ÅÆË©≥Á¥∞„Å™ÂÜÖÂÆπ„ÇíË™≠„ÇÄ„Å´„ÅØ„ÄÅÂÖÉË®ò‰∫ã„ÅÆ„É™„É≥„ÇØ„Çí„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ'}</p>
                    <p class="text-muted">
                        <small>
                            <i class="fas fa-info-circle me-1"></i>
                            ÂÆåÂÖ®„Å™Ë®ò‰∫ã„ÇíË™≠„ÇÄ„Å´„ÅØ„ÄåÂÖÉË®ò‰∫ã„ÇíË™≠„ÇÄ„Äç„Éú„Çø„É≥„Çí„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
                        </small>
                    </p>
                </div>
            `;
        }

        const bootstrapModal = new bootstrap.Modal(modal);
        bootstrapModal.show();
    }

    applyFilters() {
        const categoryFilter = document.getElementById('categoryFilter')?.value || 'all';
        const sourceFilter = document.getElementById('sourceFilter')?.value || 'all';
        const timeFilter = document.getElementById('timeFilter')?.value || '24h';

        this.filteredNews = this.newsData.filter(item => {
            // Category filter
            if (categoryFilter !== 'all' && item.category !== categoryFilter) {
                return false;
            }

            // Source filter
            if (sourceFilter !== 'all' && !item.source.toLowerCase().includes(sourceFilter)) {
                return false;
            }

            // Time filter
            const now = new Date();
            const itemTime = new Date(item.published);
            let timeThreshold;

            switch (timeFilter) {
                case '24h':
                    timeThreshold = new Date(now - 24 * 60 * 60 * 1000);
                    break;
                case '7d':
                    timeThreshold = new Date(now - 7 * 24 * 60 * 60 * 1000);
                    break;
                case '30d':
                    timeThreshold = new Date(now - 30 * 24 * 60 * 60 * 1000);
                    break;
                default:
                    timeThreshold = new Date(0);
            }

            if (itemTime < timeThreshold) {
                return false;
            }

            return true;
        });

        this.displayNews();
    }

    async refreshNews() {
        this.newsData = [];
        this.filteredNews = [];
        this.currentPage = 1;
        await this.loadNews();
    }

    loadMoreNews() {
        // In a real implementation, this would load more pages from the API
        this.showToast('„Åô„Åπ„Å¶„ÅÆ„Éã„É•„Éº„Çπ„ÅåË™≠„ÅøËæº„Åæ„Çå„Å¶„ÅÑ„Åæ„Åô', 'info');
    }

    displaySampleNews() {
        const sampleNews = [
            {
                title: "Bitcoin‰æ°Ê†º„Åå50,000„Éâ„É´„ÅÆÂ§ßÂè∞„ÇíÁ™ÅÁ†¥„ÄÅÊ©üÈñ¢ÊäïË≥áÂÆ∂„ÅÆÂèÇÂÖ•„ÅåÂä†ÈÄü",
                source: "CryptoNews Japan",
                published: new Date(Date.now() - 2 * 60 * 60 * 1000),
                summary: "„Éì„ÉÉ„Éà„Ç≥„Ç§„É≥„ÅÆ‰æ°Ê†º„ÅåÂøÉÁêÜÁöÑ„Å™ÁØÄÁõÆ„Åß„ÅÇ„Çã50,000„Éâ„É´„Çí‰∏äÂõû„Çä„ÄÅÊ©üÈñ¢ÊäïË≥áÂÆ∂„Åã„Çâ„ÅÆÂ§ßÈáè„ÅÆË≥áÈáëÊµÅÂÖ•„ÅåÁ∂ö„ÅÑ„Å¶„ÅÑ„Çã„ÄÇÂ∏ÇÂ†¥Â∞ÇÈñÄÂÆ∂„Çâ„ÅØ‰ªäÂæå„ÅÆÂ±ïÈñã„Å´„Å§„ÅÑ„Å¶Ê•ΩË¶≥ÁöÑ„Å™Ë¶ãÊñπ„ÇíÁ§∫„Åó„Å¶„ÅÑ„Çã„ÄÇ",
                url: "https://example.com/bitcoin-50k",
                category: "bitcoin",
                sentiment: "positive"
            },
            {
                title: "„Ç§„Éº„Çµ„É™„Ç¢„É†2.0„ÅÆ„Çπ„ÉÜ„Éº„Ç≠„É≥„Ç∞ÂèÇÂä†ËÄÖ„Åå1,500‰∏á‰∫∫„ÇíË∂Ö„Åà„Çã",
                source: "DeFi Today",
                published: new Date(Date.now() - 4 * 60 * 60 * 1000),
                summary: "„Ç§„Éº„Çµ„É™„Ç¢„É†2.0„ÅÆ„Çπ„ÉÜ„Éº„Ç≠„É≥„Ç∞„Éó„Éº„É´„Å∏„ÅÆÂèÇÂä†ËÄÖÊï∞„ÅåÊÄ•ÈÄü„Å´Â¢óÂä†„Åó„Å¶„Åä„Çä„ÄÅ„Éç„ÉÉ„Éà„ÉØ„Éº„ÇØ„ÅÆ„Çª„Ç≠„É•„É™„ÉÜ„Ç£„Å®„Çπ„Ç±„Éº„É©„Éì„É™„ÉÜ„Ç£„ÅÆÂêë‰∏ä„Å´Ë≤¢ÁåÆ„Åó„Å¶„ÅÑ„Çã„ÄÇ",
                url: "https://example.com/eth2-staking",
                category: "ethereum",
                sentiment: "positive"
            },
            {
                title: "Á±≥SEC„ÄÅÊñ∞„Åü„Å™ÊöóÂè∑Ë≥áÁî£Ë¶èÂà∂„Ç¨„Ç§„Éâ„É©„Ç§„É≥„ÇíÁô∫Ë°®",
                source: "Regulatory Watch",
                published: new Date(Date.now() - 6 * 60 * 60 * 1000),
                summary: "Á±≥ÂõΩË®ºÂà∏ÂèñÂºïÂßîÂì°‰ºöÔºàSECÔºâ„ÅåÊöóÂè∑Ë≥áÁî£ÂèñÂºïÊâÄ„Å´ÂØæ„Åô„ÇãÊñ∞„Åó„ÅÑË¶èÂà∂Ë¶Å‰ª∂„ÇíÂÖ¨Ë°®„Åó„ÄÅÊ•≠Áïå„ÅÆÈÄèÊòéÊÄßÂêë‰∏ä„ÇíÁõÆÊåá„Åó„Å¶„ÅÑ„Çã„ÄÇ",
                url: "https://example.com/sec-guidelines",
                category: "regulation",
                sentiment: "neutral"
            },
            {
                title: "DeFi„ÅÆÁ∑è„É≠„ÉÉ„ÇØ‰æ°ÂÄ§ÔºàTVLÔºâ„ÅåÂè≤‰∏äÊúÄÈ´ò„ÅÆ300ÂÑÑ„Éâ„É´„Å´Âà∞ÈÅî",
                source: "DeFi Pulse",
                published: new Date(Date.now() - 8 * 60 * 60 * 1000),
                summary: "ÂàÜÊï£ÂûãÈáëËûç„Éó„É≠„Éà„Ç≥„É´ÂÖ®‰Ωì„ÅÆÁ∑è„É≠„ÉÉ„ÇØ‰æ°ÂÄ§„ÅåÈÅéÂéªÊúÄÈ´ò„ÇíÊõ¥Êñ∞„Åó„ÄÅDeFi „Ç®„Ç≥„Ç∑„Çπ„ÉÜ„É†„ÅÆÊÄ•ÊøÄ„Å™ÊàêÈï∑„ÇíÁ§∫„Åó„Å¶„ÅÑ„Çã„ÄÇ",
                url: "https://example.com/defi-tvl-record",
                category: "defi",
                sentiment: "positive"
            },
            {
                title: "Layer 2„ÇΩ„É™„É•„Éº„Ç∑„Éß„É≥„ÄÅ„Ç¨„Çπ‰ª£„Çí99%ÂâäÊ∏õ„Åô„ÇãÊñ∞ÊäÄË°ì„ÇíÂ∞éÂÖ•",
                source: "Tech Crypto",
                published: new Date(Date.now() - 10 * 60 * 60 * 1000),
                summary: "Ë§áÊï∞„ÅÆLayer 2„Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÅåÊñ∞„Åó„ÅÑÊäÄË°ì„ÇíÂ∞éÂÖ•„Åó„ÄÅÂèñÂºïÊâãÊï∞Êñô„ÅÆÂ§ßÂπÖ„Å™ÂâäÊ∏õ„Å´ÊàêÂäü„ÄÇ„É¶„Éº„Ç∂„Éì„É™„ÉÜ„Ç£„ÅÆÂêë‰∏ä„ÅåÊúüÂæÖ„Åï„Çå„Çã„ÄÇ",
                url: "https://example.com/layer2-gas-reduction",
                category: "technology",
                sentiment: "positive"
            },
            {
                title: "‰∏≠Â§ÆÈäÄË°å„Éá„Ç∏„Çø„É´ÈÄöË≤®ÔºàCBDCÔºâ„ÅÆÂÆüË®ºÂÆüÈ®ì„ÄÅ‰∏ñÁïå10„Ç´ÂõΩ„ÅßÂêåÊôÇÈñãÂßã",
                source: "Global Finance",
                published: new Date(Date.now() - 12 * 60 * 60 * 1000),
                summary: "‰∏ñÁïåÂêÑÂõΩ„ÅÆ‰∏≠Â§ÆÈäÄË°å„ÅåCBDC„ÅÆÂÆüË®ºÂÆüÈ®ì„ÇíÈñãÂßã„Åó„ÄÅ„Éá„Ç∏„Çø„É´Ê±∫Ê∏à„ÅÆÊú™Êù•„Å´Âêë„Åë„ÅüÈáçË¶Å„Å™‰∏ÄÊ≠©„ÇíË∏è„ÅøÂá∫„Åó„Å¶„ÅÑ„Çã„ÄÇ",
                url: "https://example.com/cbdc-trials",
                category: "regulation",
                sentiment: "neutral"
            }
        ];

        // Add IDs and enhanced data
        this.newsData = sampleNews.map((item, index) => ({
            ...item,
            id: `sample-news-${index}`,
            publishedDate: item.published
        }));

        this.filteredNews = [...this.newsData];
        this.displayNews();
    }

    showNoResults() {
        const container = document.getElementById('newsContainer');
        if (container) {
            container.innerHTML = `
                <div class="col-12">
                    <div class="no-results">
                        <i class="fas fa-search"></i>
                        <h4>„Éã„É•„Éº„Çπ„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì</h4>
                        <p>„Éï„Ç£„É´„Çø„ÉºÊù°‰ª∂„ÇíÂ§âÊõ¥„Åó„Å¶ÂÜçÂ∫¶„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ</p>
                        <button class="btn btn-primary mt-3" onclick="this.clearFilters()">
                            „Éï„Ç£„É´„Çø„Éº„Çí„ÇØ„É™„Ç¢
                        </button>
                    </div>
                </div>
            `;
        }
    }

    clearFilters() {
        document.getElementById('categoryFilter').value = 'all';
        document.getElementById('sourceFilter').value = 'all';
        document.getElementById('timeFilter').value = '24h';
        this.applyFilters();
    }

    showLoadingSpinner(show) {
        const spinner = document.getElementById('loadingSpinner');
        if (spinner) {
            spinner.style.display = show ? 'block' : 'none';
        }
    }

    formatTimeAgo(date) {
        const now = new Date();
        const diffMs = now - date;
        const diffMins = Math.floor(diffMs / 60000);
        const diffHours = Math.floor(diffMins / 60);
        const diffDays = Math.floor(diffHours / 24);

        if (diffMins < 1) return '„Åü„Å£„Åü‰ªä';
        if (diffMins < 60) return `${diffMins}ÂàÜÂâç`;
        if (diffHours < 24) return `${diffHours}ÊôÇÈñìÂâç`;
        if (diffDays < 7) return `${diffDays}Êó•Ââç`;
        
        return date.toLocaleDateString('ja-JP');
    }

    showToast(message, type = 'info') {
        // Create toast notification
        const toast = document.createElement('div');
        toast.className = `alert alert-${type === 'error' ? 'danger' : type} position-fixed`;
        toast.style.cssText = `
            top: 20px;
            right: 20px;
            z-index: 1060;
            min-width: 300px;
            animation: slideInRight 0.3s ease;
        `;
        
        const icon = type === 'success' ? 'check-circle' : 
                    type === 'error' ? 'exclamation-triangle' : 
                    type === 'warning' ? 'exclamation-circle' : 'info-circle';
        
        toast.innerHTML = `
            <i class="fas fa-${icon} me-2"></i>${message}
            <button type="button" class="btn-close" onclick="this.parentElement.remove()"></button>
        `;
        
        document.body.appendChild(toast);
        
        // Auto-remove after 3 seconds
        setTimeout(() => {
            if (toast.parentElement) {
                toast.style.animation = 'slideOutRight 0.3s ease';
                setTimeout(() => toast.remove(), 300);
            }
        }, 3000);
    }
}

// Animation CSS
const style = document.createElement('style');
style.textContent = `
    @keyframes slideInRight {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }
    @keyframes slideOutRight {
        from {
            transform: translateX(0);
            opacity: 1;
        }
        to {
            transform: translateX(100%);
            opacity: 0;
        }
    }
`;
document.head.appendChild(style);

// Global function for clearing filters
window.clearFilters = function() {
    if (window.cryptoNewsApp) {
        window.cryptoNewsApp.clearFilters();
    }
};

// Initialize the news app when DOM is loaded
document.addEventListener('DOMContentLoaded', () => {
    window.cryptoNewsApp = new CryptoNewsApp();
});